# Предсказание продаж товаров

## Задача

Предсказание количества проданных единиц кроссовок на основе исторических данных о ценах, промо-акциях и остатках на складе.

## Данные

Файлы `train.parquet` и `test.parquet` содержат следующие колонки:

| Колонка | Описание |
|---------|----------|
| `nm_id` | Анонимный идентификатор товара |
| `dt` | Дата |
| `price` | Цена товара в этот день |
| `is_promo` | Флаг участия товара в промо-акции |
| `prev_leftovers` | Остаток товара на складе на начало дня |
| `qty` | Количество проданных единиц (только в train, целевой признак) |

Период данных: 2024-07-04 -- 2025-07-07.

## Решение

### Feature Engineering

Генерация признаков реализована в `features_all.py` и разбита на 8 блоков, каждый из которых представлен отдельной функцией:

**Временные признаки** (`add_temporal_features`): календарные атрибуты даты: день недели, месяц, флаги выходных и начала/конца месяца, линейный тренд, циклическая кодировка через sin/cos.

**Ценовые признаки** (`add_price_features`): динамика цены товара: абсолютное и относительное изменение, скользящие средние/минимумы/максимумы за 7/14/30 дней, глубина скидки от исторического максимума, перцентиль цены, количество дней с последнего изменения цены.

**Промо-признаки** (`add_promo_features`): характеристики промо-активности: длительность текущей промо-серии, дней с последнего промо, частота промо за 30 дней, флаги начала и конца промо-периода, взаимодействие промо с глубиной скидки.

**Признаки остатков** (`add_leftovers_features`): динамика складских остатков: скользящие средние, изменение остатков, тренд за 7 дней (наклон линейной регрессии), флаг низкого остатка.

**Лаги продаж** (`add_sales_lag_features`): лаговые значения qty за 1/7/14/28 дней, скользящие средние и стандартные отклонения продаж, expanding mean. Все статистики сдвинуты на 1 день для предотвращения утечки.

**Товарные признаки** (`add_item_features`): агрегатные характеристики товара: средние продажи, средняя цена, волатильность цены, количество дней в данных.

**Ценовая эластичность** (`add_elasticity_features`): скользящая корреляция цены и продаж за 30 дней, псевдо-эластичность как отношение процентных изменений qty и price.

**Взаимодействия** (`add_interaction_features`): попарные произведения: цена на промо, день недели на промо, остатки на промо.

### Предотвращение утечки данных

Для корректного подсчета признаков на test-данных train и test объединяются в единый таймлайн. Значения `qty` в test-строках заменяются на NaN (`qty_safe`), после чего все лаговые и скользящие статистики считаются по этому замаскированному столбцу. Это гарантирует, что модель не использует информацию из будущего, даже если test-строки расположены между train-строками.

### Модель

CatBoostRegressor с функцией потерь взвешенного MAE.

Веса наблюдений: 7.0 для строк с `qty > 0`, 1.0 для нулевых продаж.

Подбор гиперпараметров выполнен через Optuna (50 trials) по следующим параметрам: learning rate, глубина дерева, L2-регуляризация, min data in leaf, bagging temperature, random strength.

### Трекинг экспериментов

Все эксперименты логируются в MLflow. Каждый trial Optuna записывается как вложенный run, финальная модель с лучшими параметрами сохраняется в родительском run вместе с важностью признаков.

## Структура проекта

```
.
├── README.md
├── features_all.py           # Генерация признаков (8 блоков)
├── train.parquet             # Обучающие данные
├── test.parquet              # Тестовые данные
└── submission.csv            # Предсказания
```

## Результаты

| Конфигурация | Weighted MAE |
|--------------|-------------|
| Baseline (без доп. признаков) | 3.1 |
| С feature engineering | 2.5 |
| С feature engineering + Optuna | 2.45 |

## Запуск

```python
import pandas as pd
import numpy as np
from features_all import *
from catboost import CatBoostRegressor, Pool

# Загрузка и подготовка
train_raw = pd.read_parquet("train.parquet")
test_raw = pd.read_parquet("test.parquet")
train_raw["dt"] = pd.to_datetime(train_raw["dt"])
test_raw["dt"] = pd.to_datetime(test_raw["dt"])

# Объединение, генерация признаков, обучение, предсказание
# (см. основной ноутбук)
```